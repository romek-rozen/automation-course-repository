# =============================================================================
# DOCKER COMPOSE - NOCODB WITH MINIO (VPS)
# =============================================================================
# Stack zawiera:
# - Caddy (reverse proxy z automatycznym HTTPS)
# - NocoDB (no-code database)
# - PostgreSQL (baza danych)
# - Redis (cache dla NocoDB)
# - MinIO (S3-compatible storage)
# =============================================================================

services:
  # === REVERSE PROXY ===
  caddy:
    image: caddy:latest
    restart: unless-stopped
    env_file: .env
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./volumes/caddy_config/Caddyfile:/etc/caddy/Caddyfile
      - ./volumes/caddy_data:/data
      - ./volumes/caddy_config:/config
    environment:
      - CADDY_INGRESS_NETWORKS=caddy
      - NOCODB_DOMAIN=${NOCODB_DOMAIN}
      - MINIO_DOMAIN=${MINIO_DOMAIN}
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    networks:
      - caddy

  # === NOCODB ===
  nocodb:
    image: nocodb/nocodb:latest
    restart: unless-stopped
    env_file: .env
    depends_on:
      pg_database:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - ./volumes/nocodb:/usr/app/data
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    environment:
      - NC_DB=pg://pg_database:5432?d=${POSTGRES_NOCODB_DB}&u=${POSTGRES_NOCODB_USER}&p=${POSTGRES_NOCODB_PASSWORD}
      - NC_AUTH_JWT_SECRET=${NC_JWT_SECRET}
      - NC_INVITE_ONLY_SIGNUP=true
      - NC_DISABLE_TELE=true
      - DB_QUERY_LIMIT_DEFAULT=25
      - DB_QUERY_LIMIT_GROUP_BY_GROUP=10
      - DB_QUERY_LIMIT_GROUP_BY_RECORD=10
      - DB_QUERY_LIMIT_MAX=100
      - NC_ALLOW_LOCAL_HOOKS=true
      - PORT=8080
      - NC_REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/15
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 256M
    networks:
      - caddy

  # === POSTGRESQL ===
  pg_database:
    image: postgres:16
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_NOCODB_DB: ${POSTGRES_NOCODB_DB}
      POSTGRES_NOCODB_USER: ${POSTGRES_NOCODB_USER}
      POSTGRES_NOCODB_PASSWORD: ${POSTGRES_NOCODB_PASSWORD}
    volumes:
      - ./volumes/db_data:/var/lib/postgresql/data
      - ./init-data.sh:/docker-entrypoint-initdb.d/init-data.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    expose:
      - "5432"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 256M
    networks:
      - caddy

  # === REDIS ===
  redis:
    image: redis:8-alpine
    restart: unless-stopped
    env_file: .env
    command: redis-server --requirepass "${REDIS_PASSWORD}" --maxmemory 512mb --maxmemory-policy volatile-lru --maxmemory-samples 5
    volumes:
      - ./volumes/redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    expose:
      - "6379"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 64M
    networks:
      - caddy

  # === MINIO (S3 Storage) ===
  minio:
    image: minio/minio:latest
    restart: unless-stopped
    env_file: .env
    entrypoint: /bin/sh
    command: -c 'mkdir -p /data/nocodb && minio server /data --console-address ":9001"'
    volumes:
      - ./volumes/minio_data:/data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    expose:
      - "9000"
      - "9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          memory: 128M
    networks:
      - caddy

networks:
  caddy:
    external: true
