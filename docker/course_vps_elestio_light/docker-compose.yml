# =============================================================================
# DOCKER COMPOSE - ELESTIO LIGHT STACK
# =============================================================================
# Stack dla Elestio CI/CD - bez Caddy (Elestio zapewnia Nginx reverse proxy)
# Zawiera:
# - n8n (workflow automation) - single instance
# - NocoDB (no-code database)
# - PostgreSQL (glowna baza danych)
# - Redis (cache i dane dla workflow)
# - MinIO (S3-compatible storage)
# =============================================================================

services:
  # === N8N - SINGLE INSTANCE ===
  n8n:
    image: docker.n8n.io/n8nio/n8n:${SOFTWARE_VERSION_TAG:-latest}
    restart: always
    env_file: .env
    depends_on:
      pg-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    ports:
      - "172.17.0.1:5678:5678"
    environment:
      - N8N_HOST=${DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=4096
      - NODE_FUNCTION_ALLOW_EXTERNAL=cheerio,imap,util,quoted-printable,mailparser
      - WEBHOOK_URL=https://${DOMAIN}/
      - WEBHOOK_TUNNEL_URL=https://${DOMAIN}
      - N8N_PROXY_HOPS=1
      - GENERIC_TIMEZONE=${N8N_GENERIC_TIMEZONE}
      # Baza danych
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=pg_database
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_N8N_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_N8N_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_N8N_PASSWORD}
      # Bezpieczenstwo
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      - N8N_RESTRICT_FILE_ACCESS_TO=/files
      - N8N_SKIP_AUTH_ON_OAUTH_CALLBACK=false
      # Czyszczenie danych
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336
      - EXECUTIONS_DATA_PRUNE_MAX_COUNT=10000
      # Wydajnosc
      - N8N_DEFAULT_BINARY_DATA_MODE=database
      # Community packages
      - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true
      - N8N_NODE_MODULES_TO_ALLOW=cheerio
      # SMTP (Elestio local SMTP)
      - N8N_EMAIL_MODE=smtp
      - N8N_SMTP_HOST=${N8N_SMTP_HOST}
      - N8N_SMTP_PORT=${N8N_SMTP_PORT}
      - N8N_SMTP_USER=${N8N_SMTP_USER}
      - N8N_SMTP_PASS=${N8N_SMTP_PASS}
      - N8N_SMTP_SENDER=${N8N_SMTP_SENDER}
      - N8N_SMTP_SSL=false
      # Metryki
      - N8N_METRICS=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 8.8.8.8
      - 1.1.1.1
      - 9.9.9.9
    volumes:
      - ./volumes/n8n/data:/home/node/.n8n
      - ./volumes/n8n/local_files:/files

  # === NOCODB ===
  nocodb:
    image: nocodb/nocodb:latest
    env_file: .env
    depends_on:
      pg-init:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: always
    ports:
      - "172.17.0.1:8080:8080"
    volumes:
      - ./volumes/nocodb:/usr/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    environment:
      - NC_DB=pg://pg_database:5432?d=${POSTGRES_NOCODB_DB}&u=${POSTGRES_NOCODB_USER}&p=${POSTGRES_NOCODB_PASSWORD}
      - NC_AUTH_JWT_SECRET=${NC_JWT_SECRET}
      - NC_INVITE_ONLY_SIGNUP=true
      - NC_DISABLE_TELE=true
      - DB_QUERY_LIMIT_DEFAULT=25
      - DB_QUERY_LIMIT_GROUP_BY_GROUP=10
      - DB_QUERY_LIMIT_GROUP_BY_RECORD=10
      - DB_QUERY_LIMIT_MAX=100
      - NC_ALLOW_LOCAL_HOOKS=true
      - PORT=8080
      - NC_REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/15
      # MinIO S3 Storage
      - NC_S3_BUCKET_NAME=nocodb
      - NC_S3_REGION=us-east-1
      - NC_S3_ACCESS_KEY=${MINIO_ROOT_USER}
      - NC_S3_ACCESS_SECRET=${MINIO_ROOT_PASSWORD}
      - NC_S3_ENDPOINT=http://minio:9000
      - NC_S3_FORCE_PATH_STYLE=true

  # === POSTGRESQL ===
  pg_database:
    image: postgres:16
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
    volumes:
      - ./volumes/db_data:/var/lib/postgresql/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    expose:
      - "5432"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 512M

  # === PG-INIT (jednorazowe tworzenie baz i userow) ===
  pg-init:
    image: postgres:16
    restart: "no"
    depends_on:
      pg_database:
        condition: service_healthy
    environment:
      PGHOST: pg_database
      PGUSER: ${POSTGRES_USER}
      PGPASSWORD: ${POSTGRES_PASSWORD}
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        set -e
        echo "=== PostgreSQL Init ==="

        # Baza i user dla NocoDB
        DB_EXISTS=$$(psql -tAc "SELECT 1 FROM pg_database WHERE datname='${POSTGRES_NOCODB_DB}'" 2>/dev/null || echo "0")
        if [ "$$DB_EXISTS" != "1" ]; then
          psql -c "CREATE DATABASE ${POSTGRES_NOCODB_DB};"
          echo "Database ${POSTGRES_NOCODB_DB} created."
        fi
        USER_EXISTS=$$(psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='${POSTGRES_NOCODB_USER}'" 2>/dev/null || echo "0")
        if [ "$$USER_EXISTS" != "1" ]; then
          psql -c "CREATE USER ${POSTGRES_NOCODB_USER} WITH PASSWORD '${POSTGRES_NOCODB_PASSWORD}';"
        else
          psql -c "ALTER USER ${POSTGRES_NOCODB_USER} WITH PASSWORD '${POSTGRES_NOCODB_PASSWORD}';"
        fi
        psql -c "GRANT ALL PRIVILEGES ON DATABASE ${POSTGRES_NOCODB_DB} TO ${POSTGRES_NOCODB_USER};"
        psql -d "${POSTGRES_NOCODB_DB}" -c "GRANT CREATE ON SCHEMA public TO ${POSTGRES_NOCODB_USER}; GRANT ALL ON SCHEMA public TO ${POSTGRES_NOCODB_USER};"

        # Baza i user dla n8n
        DB_EXISTS=$$(psql -tAc "SELECT 1 FROM pg_database WHERE datname='${POSTGRES_N8N_DB}'" 2>/dev/null || echo "0")
        if [ "$$DB_EXISTS" != "1" ]; then
          psql -c "CREATE DATABASE ${POSTGRES_N8N_DB};"
          echo "Database ${POSTGRES_N8N_DB} created."
        fi
        USER_EXISTS=$$(psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='${POSTGRES_N8N_USER}'" 2>/dev/null || echo "0")
        if [ "$$USER_EXISTS" != "1" ]; then
          psql -c "CREATE USER ${POSTGRES_N8N_USER} WITH PASSWORD '${POSTGRES_N8N_PASSWORD}';"
        else
          psql -c "ALTER USER ${POSTGRES_N8N_USER} WITH PASSWORD '${POSTGRES_N8N_PASSWORD}';"
        fi
        psql -c "GRANT ALL PRIVILEGES ON DATABASE ${POSTGRES_N8N_DB} TO ${POSTGRES_N8N_USER};"
        psql -d "${POSTGRES_N8N_DB}" -c "GRANT CREATE ON SCHEMA public TO ${POSTGRES_N8N_USER}; GRANT ALL ON SCHEMA public TO ${POSTGRES_N8N_USER};"

        echo "=== PostgreSQL Init Complete ==="

  # === REDIS ===
  redis:
    image: redis:8-alpine
    env_file: .env
    command: redis-server --requirepass "${REDIS_PASSWORD}" --maxmemory 2gb --maxmemory-policy volatile-lru --maxmemory-samples 5
    restart: always
    volumes:
      - ./volumes/redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    expose:
      - "6379"

  # === MINIO (S3 Storage) ===
  minio:
    image: minio/minio:latest
    restart: always
    env_file: .env
    entrypoint: /bin/sh
    command: -c 'mkdir -p /data/nocodb && minio server /data --console-address ":9001"'
    ports:
      - "172.17.0.1:9000:9000"
      - "172.17.0.1:9001:9001"
    volumes:
      - ./volumes/minio_data:/data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
