# =============================================================================
# DOCKER COMPOSE - N8N WITH WORKERS (VPS)
# =============================================================================
# Stack zawiera:
# - Caddy (reverse proxy z automatycznym HTTPS)
# - n8n (workflow automation) + worker + webhook processor
# - PostgreSQL (baza danych)
# - Redis (kolejki Bull)
# =============================================================================

services:
  # === REVERSE PROXY ===
  caddy:
    image: caddy:latest
    restart: unless-stopped
    env_file: .env
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./volumes/caddy_config/Caddyfile:/etc/caddy/Caddyfile
      - ./volumes/caddy_data:/data
      - ./volumes/caddy_config:/config
    environment:
      - CADDY_INGRESS_NETWORKS=caddy
      - N8N_DOMAIN=${N8N_DOMAIN}
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    networks:
      - caddy

  # =============================================================================
  # N8N STACK - YAML ANCHOR DLA WSPOLDZIELONEJ KONFIGURACJI
  # =============================================================================
  x-n8n-shared: &n8n-shared
    image: docker.n8n.io/n8nio/n8n
    restart: unless-stopped
    env_file: .env
    depends_on:
      pg_database:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Host i protokol
      - N8N_HOST=${N8N_DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=4096
      - NODE_FUNCTION_ALLOW_EXTERNAL=cheerio,imap,util,quoted-printable,mailparser
      - WEBHOOK_URL=https://${N8N_DOMAIN}/
      - N8N_PROXY_HOPS=1
      - GENERIC_TIMEZONE=${N8N_GENERIC_TIMEZONE}
      # Baza danych PostgreSQL
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=pg_database
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_N8N_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_N8N_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_N8N_PASSWORD}
      # Kolejki Redis (Bull)
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=${QUEUE_BULL_REDIS_HOST}
      - QUEUE_BULL_REDIS_PORT=${QUEUE_BULL_REDIS_PORT}
      - QUEUE_BULL_REDIS_PASSWORD=${QUEUE_BULL_REDIS_PASSWORD}
      - QUEUE_BULL_REDIS_DB=${QUEUE_BULL_REDIS_DB}
      - QUEUE_HEALTH_CHECK_ACTIVE=true
      # Bezpieczenstwo
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_USER_MANAGEMENT_JWT_SECRET=${N8N_USER_MANAGEMENT_JWT_SECRET}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      - N8N_RESTRICT_FILE_ACCESS_TO=/files
      - N8N_SKIP_AUTH_ON_OAUTH_CALLBACK=false
      # Czyszczenie danych (prune)
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336
      - EXECUTIONS_DATA_PRUNE_MAX_COUNT=10000
      # Wydajnosc
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - N8N_CONCURRENCY_PRODUCTION_LIMIT=30
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
      # Community packages
      - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true
      - N8N_NODE_MODULES_TO_ALLOW=cheerio
      # SMTP (opcjonalne)
      - N8N_EMAIL_MODE=smtp
      - N8N_SMTP_HOST=${N8N_SMTP_HOST}
      - N8N_SMTP_PORT=${N8N_SMTP_PORT}
      - N8N_SMTP_USER=${N8N_SMTP_USER}
      - N8N_SMTP_PASS=${N8N_SMTP_PASS}
      - N8N_SMTP_SENDER=${N8N_SMTP_SENDER}
      - N8N_SMTP_SSL=false
      # Metryki
      - N8N_METRICS=true
      - N8N_METRICS_INCLUDE_QUEUE_METRICS=true
    volumes:
      - ./volumes/n8n/data:/home/node/.n8n
      - ./volumes/n8n/local_files:/files
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          memory: 512M
    networks:
      - caddy

  # === N8N MAIN - UI + API ===
  n8n:
    <<: *n8n-shared

  # === N8N WORKER - przetwarza zadania z kolejki ===
  n8n-worker:
    <<: *n8n-shared
    command: worker
    depends_on:
      - n8n
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 3G
        reservations:
          memory: 256M

  # === N8N WEBHOOK - odbiera webhooki produkcyjne ===
  n8n-webhook:
    <<: *n8n-shared
    command: webhook
    depends_on:
      - n8n

  # =============================================================================
  # POSTGRESQL - BAZA DANYCH
  # =============================================================================
  pg_database:
    image: postgres:16
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_N8N_DB: ${POSTGRES_N8N_DB}
      POSTGRES_N8N_USER: ${POSTGRES_N8N_USER}
      POSTGRES_N8N_PASSWORD: ${POSTGRES_N8N_PASSWORD}
    volumes:
      - ./volumes/db_data:/var/lib/postgresql/data
      - ./init-data.sh:/docker-entrypoint-initdb.d/init-data.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    expose:
      - "5432"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 512M
    networks:
      - caddy

  # =============================================================================
  # REDIS - KOLEJKI BULL
  # =============================================================================
  redis:
    image: redis:8-alpine
    env_file: .env
    command: redis-server --requirepass "${REDIS_PASSWORD}" --maxmemory 1gb --maxmemory-policy volatile-lru --maxmemory-samples 5
    restart: unless-stopped
    volumes:
      - ./volumes/redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    expose:
      - "6379"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          memory: 128M
    networks:
      - caddy

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  caddy:
    external: true
