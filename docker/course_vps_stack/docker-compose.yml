# =============================================================================
# DOCKER COMPOSE - SZABLON DO KURSU
# =============================================================================
# Stack zawiera:
# - Caddy (reverse proxy z automatycznym HTTPS)
# - n8n (workflow automation) + worker + webhook processor
# - NocoDB (no-code database)
# - PostgreSQL (glowna baza danych)
# - Redis (cache i kolejki)
# - MinIO (S3-compatible storage)
# - Qdrant (vector database)
# Aktualizacje reczne: docker compose pull && docker compose up -d
# =============================================================================

services:
  # === REVERSE PROXY ===
  caddy:
    image: caddy:latest
    restart: unless-stopped
    env_file: .env
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./volumes/caddy_config/Caddyfile:/etc/caddy/Caddyfile
      - ./volumes/caddy_data:/data
      - ./volumes/caddy_config:/config
    environment:
      - CADDY_INGRESS_NETWORKS=caddy
      - DOMAIN=${DOMAIN}
      - NOCODB_DOMAIN=${NOCODB_DOMAIN}
      - MINIO_DOMAIN=${MINIO_DOMAIN}
      - N8N_DOMAIN=${N8N_DOMAIN}
      - QDRANT_DOMAIN=${QDRANT_DOMAIN}
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - caddy

  # === N8N STACK ===
  # Wspolna konfiguracja dla wszystkich instancji n8n
  x-n8n-shared: &n8n-shared
    image: docker.n8n.io/n8nio/n8n
    restart: unless-stopped
    env_file: .env
    depends_on:
      pg_database:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - N8N_HOST=${N8N_DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - NODE_ENV=production
      - NODE_OPTIONS=--max-old-space-size=4096
      - NODE_FUNCTION_ALLOW_EXTERNAL=cheerio,imap,util,quoted-printable,mailparser
      - WEBHOOK_URL=https://${N8N_DOMAIN}/
      - N8N_PROXY_HOPS=1
      - GENERIC_TIMEZONE=${N8N_GENERIC_TIMEZONE}
      # Baza danych
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=pg_database
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_N8N_DB}
      - DB_POSTGRESDB_USER=${POSTGRES_N8N_USER}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_N8N_PASSWORD}
      # Kolejki Redis
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=${QUEUE_BULL_REDIS_HOST}
      - QUEUE_BULL_REDIS_PORT=${QUEUE_BULL_REDIS_PORT}
      - QUEUE_BULL_REDIS_PASSWORD=${QUEUE_BULL_REDIS_PASSWORD}
      - QUEUE_BULL_REDIS_DB=${QUEUE_BULL_REDIS_DB}
      - QUEUE_HEALTH_CHECK_ACTIVE=true
      # Bezpieczenstwo
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      - N8N_RESTRICT_FILE_ACCESS_TO=/files
      - N8N_SKIP_AUTH_ON_OAUTH_CALLBACK=false
      # Czyszczenie danych
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336
      - EXECUTIONS_DATA_PRUNE_MAX_COUNT=10000
      # Wydajnosc
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - N8N_CONCURRENCY_PRODUCTION_LIMIT=30
      - N8N_DEFAULT_BINARY_DATA_MODE=database
      # Community packages
      - N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true
      - N8N_NODE_MODULES_TO_ALLOW=cheerio
      # SMTP (opcjonalne)
      - N8N_EMAIL_MODE=smtp
      - N8N_SMTP_HOST=${N8N_SMTP_HOST}
      - N8N_SMTP_PORT=${N8N_SMTP_PORT}
      - N8N_SMTP_USER=${N8N_SMTP_USER}
      - N8N_SMTP_PASS=${N8N_SMTP_PASS}
      - N8N_SMTP_SENDER=${N8N_SMTP_SENDER}
      - N8N_SMTP_SSL=false
      # Metryki
      - N8N_METRICS=true
      - N8N_METRICS_INCLUDE_QUEUE_METRICS=true
    volumes:
      - ./volumes/n8n/data:/home/node/.n8n
      - ./volumes/n8n/local_files:/files
    networks:
      - caddy

  # Glowna instancja n8n (UI + API)
  n8n:
    <<: *n8n-shared

  # Worker - przetwarza zadania z kolejki
  n8n-worker:
    <<: *n8n-shared
    command: worker
    depends_on:
      - n8n

  # Webhook processor - odbiera webhooki produkcyjne
  n8n-webhook:
    <<: *n8n-shared
    command: webhook
    depends_on:
      - n8n

  # === NOCODB ===
  nocodb:
    image: nocodb/nocodb:latest
    env_file: .env
    depends_on:
      pg_database:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./volumes/nocodb:/usr/app/data
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - caddy
    environment:
      - NC_DB=pg://pg_database:5432?d=${POSTGRES_NOCODB_DB}&u=${POSTGRES_NOCODB_USER}&p=${POSTGRES_NOCODB_PASSWORD}
      - NC_AUTH_JWT_SECRET=${NC_JWT_SECRET}
      - NC_INVITE_ONLY_SIGNUP=true
      - NC_DISABLE_TELE=true
      - DB_QUERY_LIMIT_DEFAULT=25
      - DB_QUERY_LIMIT_GROUP_BY_GROUP=10
      - DB_QUERY_LIMIT_GROUP_BY_RECORD=10
      - DB_QUERY_LIMIT_MAX=100
      - NC_ALLOW_LOCAL_HOOKS=true
      - PORT=8080
      - NC_REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/15

  # === POSTGRESQL ===
  pg_database:
    image: postgres:16
    env_file: .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: postgres
      # Zmienne dla init-data.sh (tworzenie baz i userow dla aplikacji)
      POSTGRES_NOCODB_DB: ${POSTGRES_NOCODB_DB}
      POSTGRES_NOCODB_USER: ${POSTGRES_NOCODB_USER}
      POSTGRES_NOCODB_PASSWORD: ${POSTGRES_NOCODB_PASSWORD}
      POSTGRES_N8N_DB: ${POSTGRES_N8N_DB}
      POSTGRES_N8N_USER: ${POSTGRES_N8N_USER}
      POSTGRES_N8N_PASSWORD: ${POSTGRES_N8N_PASSWORD}
    volumes:
      - ./volumes/db_data:/var/lib/postgresql/data
      - ./init-data.sh:/docker-entrypoint-initdb.d/init-data.sh
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    expose:
      - "5432"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          memory: 512M
    networks:
      - caddy

  # === REDIS ===
  redis:
    image: redis:8-alpine
    env_file: .env
    command: redis-server --requirepass "${REDIS_PASSWORD}" --maxmemory 2gb --maxmemory-policy volatile-lru --maxmemory-samples 5
    restart: unless-stopped
    volumes:
      - ./volumes/redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    expose:
      - "6379"
    networks:
      - caddy

  # === MINIO (S3 Storage) ===
  minio:
    image: minio/minio:latest
    restart: unless-stopped
    env_file: .env
    entrypoint: /bin/sh
    command: -c 'mkdir -p /data/nocodb && minio server /data --console-address ":9001"'
    volumes:
      - ./volumes/minio_data:/data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    expose:
      - "9000"  # API
      - "9001"  # Console
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - caddy

  # === QDRANT (Vector Database) ===
  qdrant:
    image: qdrant/qdrant:latest
    restart: unless-stopped
    env_file: .env
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY:-}
      - QDRANT__SERVICE__JWT_RBAC=true
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__STORAGE__ON_DISK_PAYLOAD=true
    volumes:
      - ./volumes/qdrant_storage:/qdrant/storage
    expose:
      - "6333"  # REST API
      - "6334"  # gRPC API
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c ':> /dev/tcp/localhost/6333' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    networks:
      - caddy

networks:
  caddy:
    external: true
